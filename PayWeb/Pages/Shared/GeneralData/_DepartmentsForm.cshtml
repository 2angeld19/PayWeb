@model PayWeb.Controllers.GeneralDataController.DepartmentViewModel
@using PayWeb.Models
@using System.Collections.Generic

<div class="row">
    <!-- Columna izquierda: Tabla de datos -->
    <div class="col-md-6">
        @{
            var tableModel = new DataTableViewModel
            {
                TableId = "departmentsTable",
                EntityName = "Departamentos",
                FormId = "departmentsForm",
                Columns = new List<DataTableColumn>
        {
        new DataTableColumn { Field = "id", Title = "ID", Width = "50px" },
        new DataTableColumn { Field = "code", Title = "Código", Width = "100px" },
        new DataTableColumn { Field = "name", Title = "Nombre del Departamento" }
        },
                Data = Model?.Departments?.Select(d => new
                {
                    id = d.Id,
                    code = d.DepartmentCode ?? "",
                    name = d.DepartmentName
                }).ToList<object>() ?? new List<object>()
            };
        }

        @await Html.PartialAsync("_DataTable", tableModel)
    </div>

    <!-- Columna derecha: Formulario de detalles -->
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body">
                <form id="departmentsForm" method="post" class="needs-validation" novalidate>
                    <input type="hidden" id="departmentId" name="Id" value="@(Model?.CurrentDepartment?.Id ?? 0)" />
                    <input type="hidden" id="companyId" name="CompanyId" value="@Model?.CompanyId" />

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="code" class="form-label">Código</label>
                            <input type="text" class="form-control" id="code" name="DepartmentCode"
                                   value="@(Model?.CurrentDepartment?.DepartmentCode ?? "")" maxlength="20">
                        </div>
                        <div class="col-md-9 mb-3">
                            <label for="departmentName" class="form-label">Nombre del Departamento</label>
                            <input type="text" class="form-control" id="departmentName" name="DepartmentName" required
                                   value="@(Model?.CurrentDepartment?.DepartmentName ?? "")" maxlength="100">
                            <div class="invalid-feedback">Por favor ingrese un nombre para el departamento.</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="managerId" class="form-label">Gerente</label>
                        <select class="form-select" id="managerId" name="ManagerId">
                            <option value="">-- Sin Gerente Asignado --</option>
                            <!-- Aquí podría ir una lista de empleados cargada dinámicamente -->
                        </select>
                    </div>

                    <div class="form-check form-switch mt-4">
                        <input class="form-check-input" type="checkbox" id="isActive" name="IsActive" checked>
                        <label class="form-check-label" for="isActive">Activo</label>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Funciones de manejo para la tabla
    window.onRowSelected_departmentsTable = function(data) {
        // Cargar los datos de la fila seleccionada en el formulario
        $('#departmentId').val(data.id);
        $('#code').val(data.code);
        $('#departmentName').val(data.name);

        // Solicitar los detalles completos de este departamento
        fetch(`/Api/Departments/GetDetails?id=${data.id}`)
            .then(response => response.json())
            .then(details => {
                // Completar el resto de campos del formulario
                $('#managerId').val(details.managerId || "");
                // Ya no se usa cssId
                //$('#cssid').val(details.cssId || "");
            })
            .catch(error => {
                console.error('Error al obtener detalles:', error);
                showToast('Error', 'No se pudieron cargar los detalles del departamento', 'error');
            });
    };

    window.onNewItem_departmentsTable = function() {
        // Limpiar el formulario para un nuevo registro
        $('#departmentsForm')[0].reset();
        $('#departmentId').val(0);
        // Mantener el ID de la compañía
        const companyId = $('#companyId').val();
        $('#companyId').val(companyId);
        $('#code').focus();
    };

    window.onSaveItem_departmentsTable = function() {
        // Validar el formulario antes de enviar
        const form = $('#departmentsForm')[0];
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
            form.classList.add('was-validated');
            return;
        }

        // Recopilar datos del formulario
        const formData = new FormData(form);

        // Enviar datos al servidor
        fetch('/Api/Departments/Save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Recargar la tabla
                var table = window.dataTable_departmentsTable;
                if (table) {
                    table.ajax.reload();
                } else {
                    // Si la tabla no tiene ajax configurado, recargar la página
                    location.reload();
                }

                // Mostrar mensaje de éxito
                showToast('Éxito', 'Departamento guardado correctamente', 'success');

                // Limpiar formulario
                window.onNewItem_departmentsTable();
            } else {
                showToast('Error', result.message || 'Error al guardar los datos', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error', 'Ocurrió un error al procesar la solicitud', 'error');
        });
    };

    window.onCancelEdit_departmentsTable = function() {
        // Restablecer el formulario sin validaciones
        $('#departmentsForm')[0].reset();
        $('#departmentsForm').removeClass('was-validated');
    };

    // Función para mostrar toasts/notificaciones
    function showToast(title, message, type) {
        // Verificar si existe Toastify o un sistema similar
        if (typeof Toastify === 'function') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: type === 'success' ? "#28a745" : "#dc3545"
            }).showToast();
        } else {
            // Fallback a alert básico
            alert(`${title}: ${message}`);
        }
    }

    // Cargar gerentes (simulado - esto podría ser reemplazado por una llamada API real)
    function loadManagers() {
        // Aquí iría una llamada API real para cargar los gerentes disponibles
        fetch('/Api/Employees/GetManagers')
            .then(response => response.json())
            .then(managers => {
                const select = $('#managerId');
                select.empty();
                select.append('<option value="">-- Sin Gerente Asignado --</option>');

                managers.forEach(manager => {
                    select.append(`<option value="${manager.id}">${manager.firstName} ${manager.lastName}</option>`);
                });
            })
            .catch(error => {
                console.error('Error al cargar gerentes:', error);
            });
    }

    // Inicializar al cargar la página
    $(document).ready(function() {
        // Por defecto, activar el modo "nuevo"
        window.onNewItem_departmentsTable();

        // Cargar gerentes disponibles
        loadManagers();
    });
</script>